vq.ScatterPlot=function(){vq.Vis.call(this)},vq.ScatterPlot.prototype=vq.extend(vq.Vis),vq.ScatterPlot.prototype.setRegression=function(a){this.data._regression=a||"none",this._render()},vq.ScatterPlot.prototype.getScales=function(a){var b=this.data,c=b.COLUMNID.x,d=b.COLUMNID.y,e=a.reduce(function(a,b){return b[c]!=null&&b[c]<a?b[c]:a},999999),f=a.reduce(function(a,b){return b[c]!=null&&b[c]>a?b[c]:a},-999999),g=a.reduce(function(a,b){return b[d]!=null&&b[d]<a?b[d]:a},999999),h=a.reduce(function(a,b){return b[d]!=null&&b[d]>a?b[d]:a},-999999),i=e-Math.abs(f-e)*.03,j=f+Math.abs(f-e)*.03,k=g-Math.abs(h-g)*.03,l=h+Math.abs(h-g)*.03,m=d3.scale.linear().domain([i,j]).range([0,b._plot.width]),n=d3.scale.linear().domain([k,l]).range([b._plot.height,0]);return{x:m,y:n,showMaxX:j,showMinX:i,showMaxY:l,showMinY:k}},vq.ScatterPlot.prototype.draw=function(a){var b=this;this.data=new vq.models.ScatterPlotData(a);if(!!this.data.isDataReady()){var c=this.data,d=c.COLUMNID.x,e=c.COLUMNID.y,f=c.COLUMNID.value,g=c._plot.width,h=c._plot.height;this.x=d,this.y=e,this.value=f,this.data_array=c.data;var i=this.getScales(this.data_array);this.xScale=i.x,this.yScale=i.y,this.regressData=this.getRegressData(i),this.vis=d3.select(c._plot.container).append("svg").attr("width",g+2*c.horizontal_padding).attr("height",h+2*c.vertical_padding),this.data_area=this.vis.append("g").attr("transform","translate("+c.horizontal_padding+","+c.vertical_padding+")").attr("width",g).attr("height",h),this.data_rect=this.data_area.append("rect").attr("class","data-rect").attr("width",g).attr("height",h).attr("stroke","#aaaaaa").attr("stroke-width",1.5).attr("fill-opacity",0).attr("pointer-events","all"),this.data_area.append("g").append("text").attr("class","axis").text(c.COLUMNLABEL.y).style("font",c._axisFont).style("text-anchor","middle").attr("transform","translate("+c.yLabelDisplacement+","+h/2+") rotate(-90)"),this.data_area.append("text").attr("class","axis").text(c.COLUMNLABEL.x).style("font",c._axisFont).attr("x",g/2).attr("y",h+c.xLabelDisplacement).style("text-anchor","middle");var j=this.data_area.append("svg").attr("left",0).attr("top",0).attr("width",g).attr("height",h).attr("viewBox","0 0 "+g+" "+h).attr("class","symbols");this.brush=d3.svg.brush(),this._render()}},vq.ScatterPlot.prototype.getRegressData=function(a){var b=this.data,c=this.x,d=this.y,e=b._regression;if(e=="none")return{type:e};if(e=="linear"){var f=this.data.data.filter(function(a,b,e){return a[d]&&a[c]}),g=d3.sum(f,function(a){return a[c]}),h=d3.sum(f,function(a){return a[d]}),i=d3.sum(f,function(a){return a[c]*a[c]}),j=d3.sum(f,function(a){return a[c]*a[d]}),k=(f.length*j-g*h)/(f.length*i-g*g),l=(h-k*g)/f.length,m=a.showMinX*.95,n=a.showMaxX*1.05,o=k*n+l,p=k*m+l,q=d3.scale.linear().domain([m,n]).range([p,o]);return{type:e,minX:m,maxX:n,scale:q}}},vq.ScatterPlot.prototype._render=function(){this.updateScales({x:this.xScale,y:this.yScale},!0)},vq.ScatterPlot.prototype.updateScales=function(a,b){var c=this,d=this.data,e=d.enableTransitions&&!b,f,g,h,i,j,k,l,m,n,o,p=d.transitionDuration,q,r,s,t,u=d._plot.width,v=d._plot.height;q=a.x,r=(q.domain()[0]+q.domain()[1])/2,s=a.y,t=(s.domain()[0]+s.domain()[1])/2,f=function(a){return"translate(0,"+s(a)+")"},g=function(a){return a>t?"translate(0,0)":"translate(0,"+v+")"},h=this.data_area.selectAll("g.y-tick").data(s.ticks(10),String),i=h.enter(),j=h.exit(),e&&(h=h.transition().duration(p)),h.attr("transform",f),i=i.insert("g","a").attr("class","y-tick").attr("transform",g).style("opacity",1e-6),i.append("line").attr("x1",0).attr("x2",u).attr("stroke","#ccc"),i.append("text").attr("x",d.yTickDisplacement).style("font",d._tickFont).attr("text-anchor","end").text(d3.format("3.2f")),e&&(i=i.transition().duration(p),j=j.transition().duration(p).style("opacity",1e-6)),i.attr("transform",f).style("opacity",1),j.remove(),k=function(a){return"translate("+q(a)+",0)"},l=function(a){return a<r?"translate(0,0)":"translate("+u+",0)"},m=this.data_area.selectAll("g.x-tick").data(q.ticks(10),Number),n=m.enter(),o=m.exit(),e&&(m=m.transition().duration(p)),m.attr("transform",k),n=n.insert("g","a").attr("class","x-tick").attr("transform",l).style("opacity",1e-6),n.append("line").attr("y1",0).attr("y2",v).attr("stroke","#ccc"),n.append("text").attr("y",v+d.xTickDisplacement).style("font",d._tickFont).attr("text-anchor","middle").text(d3.format("3.2f")),e&&(n=n.transition().duration(p),o=o.transition().duration(p).style("opacity",1e-6)),n.attr("transform",k).style("opacity",1),o.remove(),this.xScale=q,this.yScale=s,c.updateData(b)},vq.ScatterPlot.prototype.updateData=function(a){var b=this,c=this.data.data,d=this.data,e=this.data.transitionDuration,f=d.enableTransitions&&!a,g=this.data_area.select("svg.symbols").selectAll("circle").data(c,function(a){return""+a[b.x]+a[b.y]}),h=g.enter().append("circle").attr("class","fg").attr("cx",function(a){return b.xScale(a[b.x])}).attr("cy",function(a){return b.yScale(a[b.y])}).attr("r",d._radius).call(_.bind(this.setDefaultSymbolStyle,this)).style("opacity",1e-6);h.append("title").text(function(a){return d.COLUMNLABEL.value+" "+a[b.value]}),f&&(h=h.transition().duration(e)),h.style("opacity",1),g.attr("cx",function(a){return b.xScale(a[b.x])}).attr("cy",function(a){return b.yScale(a[b.y])});var i=g.exit();f&&(i=g.exit().transition().duration(e).style("opacity",1e-6)),i.remove();var j=b.regressData;if(j.type=="linear"){var k=this.data_area.select("svg.symbols").selectAll("line.regression").data([{x1:b.xScale(j.minX),y1:b.yScale(j.scale(j.minX)),x2:b.xScale(j.maxX),y2:b.yScale(j.scale(j.maxX))}],function(a){return""+a.x1+a.x2+a.y1+a.y2}),l=k.enter().append("line").attr("class","regression").attr("x1",function(a){return a.x1}).attr("y1",function(a){return a.y1}).attr("x2",function(a){return a.x2}).attr("y2",function(a){return a.y2}).attr("stroke",d._regressionStrokeStyle).style("opacity",1e-6);f&&(l=l.transition().duration(e)),l.style("opacity",1);var m=k.exit();f&&(m=k.exit().transition().duration(e).style("opacity",1e-6)),m.remove()}},vq.ScatterPlot.prototype.setDefaultSymbolStyle=function(a){var b=this.data;a.style("fill",b._fillStyle).style("stroke",b._strokeStyle).style("stroke-width",b._strokeWidth).style("opacity",1)},vq.ScatterPlot.prototype.resetData=function(a){this.data.data=a;var b=this.getScales(this.data.data);this.regressData=this.getRegressData(b),this.data_area.select("g.plot_brush").remove(),this.updateScales(b,!1)},vq.ScatterPlot.prototype.removeListeners=function(){this.data_rect.on("mousedown.zoom",null).on("mousewheel.zoom",null).on("mousemove.zoom",null).on("DOMMouseScroll.zoom",null).on("dblclick.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null)},vq.ScatterPlot.prototype.enableZoom=function(){var a=this;this.removeListeners(),this.data_area.select("g.plot_brush").remove(),this.data_area.select("svg.symbols").selectAll("circle").attr("class","fg").call(_.bind(this.setDefaultSymbolStyle,this)),this.data_rect.call(d3.behavior.zoom().x(this.xScale).y(this.yScale).on("zoom",function(){_.bind(a.updateScales,a,{x:a.xScale,y:a.yScale},!0)()}))},vq.ScatterPlot.prototype.enableBrush=function(){this.removeListeners(),this.data_area.selectAll("g.plot_brush").remove();var a=this.data_area.append("g").attr("class","plot_brush");this.brush.clear(),this.brush.x(this.xScale).y(this.yScale).on("brush",_.bind(this.brushHandler,this)).on("brushend",_.bind(this.brushEnd,this)),a.call(this.brush)},vq.ScatterPlot.prototype.brushHandler=function(){var a=this,b=this.brush.extent(),c=this.data,d=function(c){return b[0][0]<=c[a.x]&&c[a.x]<=b[1][0]&&b[0][1]<=c[a.y]&&c[a.y]<=b[1][1]};this.data_area.select("svg.symbols").selectAll("circle").attr("class",function(a){return d(a)?"fg":"bg"}).style("fill",function(a){return d(a)?c._fillStyle():c._unselectedStrokeStyle()}).style("stroke",function(a){return d(a)?c._strokeStyle():c._unselectedStrokeStyle()}).style("stroke-width",c._strokeWidth).style("opacity",function(a){return d(a)?1:.5})},vq.ScatterPlot.prototype.brushEnd=function(){var a=this,b=this.brush.extent(),c=this.data,d=c._brushHandler;this.brush.empty()&&(this.data_area.select("svg.symbols").selectAll("circle").attr("class","fg").call(_.bind(this.setDefaultSymbolStyle,this)),this.data_area.selectAll("g.plot_brush").remove()),this.data_area.select("svg.symbols").selectAll("circle").call(function(c){var f=_.chain(c[0]).map(function(a){return a.__data__}).filter(function(c){return b[0][0]<=c[a.x]&&c[a.x]<=b[1][0]&&b[0][1]<=c[a.y]&&c[a.y]<=b[1][1]}).value();f.length>0&&d(f)})},vq.models.ScatterPlotData=function(a){vq.models.VisData.call(this,a),this.setDataModel(),this.getDataType()=="vq.models.ScatterPlotData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object. Expected vq.models.ScatterPlotData object.")},vq.models.ScatterPlotData.prototype=vq.extend(vq.models.VisData),vq.models.ScatterPlotData.prototype.setDataModel=function(){this._dataModel=[{label:"_plot.width",id:"PLOT.width",cast:Number,defaultValue:512},{label:"_plot.height",id:"PLOT.height",cast:Number,defaultValue:512},{label:"_plot.container",id:"PLOT.container",optional:!0},{label:"xTickDisplacement",id:"PLOT.x_tick_displacement",cast:Number,defaultValue:15},{label:"yTickDisplacement",id:"PLOT.y_tick_displacement",cast:Number,defaultValue:-10},{label:"xLabelDisplacement",id:"PLOT.x_label_displacement",cast:Number,defaultValue:30},{label:"yLabelDisplacement",id:"PLOT.y_label_displacement",cast:Number,defaultValue:-50},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:40},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:60},{label:"enableTransitions",id:"PLOT.enable_transitions",cast:Boolean,defaultValue:!1},{label:"transitionDuration",id:"PLOT.transition_duration",cast:Number,defaultValue:1e3},{label:"data",id:"data_array",defaultValue:[]},{label:"COLUMNID.x",id:"xcolumnid",cast:String,defaultValue:"X"},{label:"COLUMNID.y",id:"ycolumnid",cast:String,defaultValue:"Y"},{label:"COLUMNID.value",id:"valuecolumnid",cast:String,defaultValue:"VALUE"},{label:"COLUMNLABEL.x",id:"xcolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.y",id:"ycolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.value",id:"valuecolumnlabel",cast:String,defaultValue:""},{label:"tooltipItems",id:"tooltip_items",defaultValue:{X:"X",Y:"Y",Value:"VALUE"}},{label:"_fillStyle",id:"fill_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"rgba(70,130,180,0.2)"}},{label:"_strokeStyle",id:"stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"steelblue"}},{label:"_unselectedStrokeStyle",id:"unselected_stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"lightgray"}},{label:"_strokeWidth",id:"stroke_width",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return 2}},{label:"_regressionStrokeStyle",id:"regression_stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"green"}},{label:"_radius",id:"radius",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return 2}},{label:"_shape",id:"shape",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"dot"}},{label:"_axisFont",id:"axis_font",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"14px helvetica"}},{label:"_tickFont",id:"tick_font",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"14px helvetica"}},{label:"_regression",id:"regression",cast:String,defaultValue:"none"},{label:"_notifier",id:"notifier",cast:Function,defaultValue:function(){return null}},{label:"_brushHandler",id:"brush_handler",cast:Function,defaultValue:function(){return null}}]},vq.models.ScatterPlotData.prototype._build_data=function(a){this._processData(a),this.COLUMNLABEL.x==""&&(this.COLUMNLABEL.x=this.COLUMNID.x),this.COLUMNLABEL.y==""&&(this.COLUMNLABEL.y=this.COLUMNID.y),this.COLUMNLABEL.value==""&&(this.COLUMNLABEL.value=this.COLUMNID.value),this.data.length>0&&this.setDataReady(!0)}